<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis MediBot - Hospital Collaboration System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Markdown renderer library (Fixed Version) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- DOMPurify for XSS Security (Pinned Version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
    
    <style>
        /* Custom Tailwind Configuration and Styling for NightOps Theme */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid #4b5563; /* Gray 600 */
            border-top: 3px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Set Inter as default font */
        body { font-family: 'Inter', sans-serif; }
        
        /* Dark Gradient Background */
        .bg-gradient-nightops {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Slate 900 to Slate 800 */
        }
        
        /* Glassmorphism Card Style */
        .card-dark {
            background-color: rgba(30, 41, 59, 0.95); /* Slate 800 */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* Slate 700 */
        }

        /* Input Styling */
        .input-dark {
            background-color: #0f172a; /* Slate 900 */
            border: 1px solid #334155; /* Slate 700 */
            color: #f3f4f6; /* Gray 100 */
        }
        .input-dark:focus {
            border-color: #3b82f6; /* Blue 500 */
            ring: 2px solid #3b82f6;
            outline: none;
        }

        /* Custom button background */
        .btn-primary {
            background-image: linear-gradient(to right, #2563eb 0%, #0ea5e9 100%); /* Blue 600 to Sky 500 */
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        /* Scrollbar styling for chat box */
        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-track { background: #0f172a; }
        .chat-box::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 3px; }
        .chat-box::-webkit-scrollbar-thumb:hover { background-color: #64748b; }

        /* --- Global Markdown Styling (Bot & Summaries) --- */
        .markdown-body {
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            line-height: 1.6;
            overflow-wrap: break-word;
        }
        
        .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4 {
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #f8fafc;
            line-height: 1.3;
        }
        .markdown-body h1 { font-size: 1.75em; border-bottom: 2px solid #475569; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #475569; padding-bottom: 0.3em; }
        .markdown-body h3 { font-size: 1.25em; }
        
        .markdown-body p { margin-bottom: 0.8em; }
        
        .markdown-body ul, .markdown-body ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
            list-style-position: outside;
        }
        .markdown-body ul { list-style-type: disc; }
        .markdown-body ol { list-style-type: decimal; }
        .markdown-body li { margin-bottom: 0.3em; }
        
        .markdown-body code {
            background-color: #1e293b;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            color: #e2e8f0;
        }
        
        .markdown-body pre {
            background-color: #0f172a;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin-bottom: 1em;
            border: 1px solid #334155;
        }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        
        .markdown-body blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            color: #94a3b8;
            background-color: rgba(59, 130, 246, 0.05);
            padding-top: 0.2em;
            padding-bottom: 0.2em;
            margin-bottom: 1em;
        }
        
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 1em; font-size: 0.9em; }
        .markdown-body table th, .markdown-body table td { border: 1px solid #475569; padding: 0.75em; text-align: left; }
        .markdown-body table th { background-color: #1e293b; color: #f8fafc; }
        
        .markdown-body a { color: #60a5fa; text-decoration: none; border-bottom: 1px dotted #60a5fa; }
        .markdown-body a:hover { border-bottom: 1px solid #60a5fa; }

        /* --- Medical Specific Tags --- */
        .medical-warning { border-left: 4px solid #fbbf24; background-color: rgba(251, 191, 36, 0.1); padding: 0.5em 1em; margin-bottom: 1em; }
        .medical-note { border-left: 4px solid #3b82f6; background-color: rgba(59, 130, 246, 0.1); padding: 0.5em 1em; margin-bottom: 1em; }
        .medical-critical { border-left: 4px solid #ef4444; background-color: rgba(239, 68, 68, 0.1); padding: 0.5em 1em; margin-bottom: 1em; }

        /* --- User Message Markdown Overrides (Blue Bubble) --- */
        .user-message-content .markdown-body { color: white; }
        .user-message-content .markdown-body h1, 
        .user-message-content .markdown-body h2, 
        .user-message-content .markdown-body h3 { color: white; border-color: rgba(255,255,255,0.3); }
        .user-message-content .markdown-body code { background-color: rgba(0,0,0,0.2); color: white; }
        .user-message-content .markdown-body pre { background-color: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.2); }
        .user-message-content .markdown-body a { color: #bfdbfe; border-bottom-color: #bfdbfe; }
        .user-message-content .markdown-body blockquote { border-left-color: white; color: rgba(255,255,255,0.9); background-color: rgba(255,255,255,0.1); }
        .user-message-content .markdown-body strong { color: white; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#2d3748' },
                        primary: { blue: '#3b82f6', cyan: '#06b6d4' }
                    }
                }
            }
        }

        // --- SECURE MARKDOWN ENGINE CONFIGURATION ---
        function configureMarked() {
            if (typeof marked === 'undefined') return;

            const renderer = new marked.Renderer();
            
            // Customize headings
            renderer.heading = function(text, level) {
                const id = text.toLowerCase().replace(/[^\w]+/g, '-');
                return `<h${level} id="${id}" class="text-blue-${400 - (level * 50)} font-semibold mt-4 mb-2 border-b border-slate-700/50 pb-1">${text}</h${level}>`;
            };
            
            // Medical Paragraphs
            renderer.paragraph = function(text) {
                const t = text.toLowerCase();
                if (t.includes('warning') || t.includes('risk')) return `<div class="medical-warning">${text}</div>`;
                if (t.includes('note') || t.includes('important')) return `<div class="medical-note">${text}</div>`;
                if (t.includes('critical') || t.includes('emergency')) return `<div class="medical-critical">${text}</div>`;
                return `<p>${text}</p>`;
            };

            // Medical Lists
            renderer.listitem = function(text) {
                // Remove auto-generated p tags from list items for cleaner layout
                const cleanText = text.replace(/^<p>|<\/p>$/g, '');
                if (cleanText.toLowerCase().match(/(symptom|treatment|diagnosis)/)) {
                    return `<li class="flex items-start"><span class="mr-2 mt-1 text-green-400">‚óè</span><span>${cleanText}</span></li>`;
                }
                return `<li>${cleanText}</li>`;
            };

            marked.setOptions({
                renderer: renderer,
                gfm: true,
                breaks: true, // IMPORTANT: Converts newlines to <br>
                pedantic: false,
                sanitize: false, // We handle sanitization separately
                smartLists: true,
                smartypants: true
            });
        }
        
        // Run config immediately
        configureMarked();
    </script>
</head>

<body class="bg-gradient-nightops min-h-screen p-4 sm:p-8 text-gray-200">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10 p-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2 tracking-tight">
                Aegis <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">MediBot</span>
            </h1>
            <p class="text-gray-400 text-lg">Secure Distributed Healthcare Intelligence System</p>
        </header>

        <!-- Status Bar -->
        <div id="status-bar" class="card-dark p-4 sm:p-6 rounded-2xl shadow-xl mb-8 flex flex-wrap justify-around gap-6 text-center">
            <!-- Groq Status -->
            <div class="status-item flex flex-col items-center group">
                <div class="flex items-center text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
                    <span id="groq-indicator" class="w-2 h-2 rounded-full mr-2 bg-gray-600 shadow-[0_0_8px_rgba(156,163,175,0.5)]"></span>
                    Groq API
                </div>
                <div id="groq-status" class="text-xl font-bold text-white group-hover:text-blue-400 transition-colors">Initializing...</div>
            </div>
            <!-- Aegis Status -->
            <div class="status-item flex flex-col items-center group">
                <div class="flex items-center text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
                    <span id="aegis-indicator" class="w-2 h-2 rounded-full mr-2 bg-gray-600 shadow-[0_0_8px_rgba(156,163,175,0.5)]"></span>
                    Aegis Network
                </div>
                <div id="aegis-status" class="text-xl font-bold text-white group-hover:text-cyan-400 transition-colors">Initializing...</div>
            </div>
            <!-- Connected Peers -->
            <div class="status-item flex flex-col items-center">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Active Nodes</div>
                <div id="peers-count" class="text-xl font-bold text-white font-mono">0</div>
            </div>
            <!-- Public Health Data -->
            <div class="status-item flex flex-col items-center">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Synced Records</div>
                <div id="public-data" class="text-xl font-bold text-white font-mono">0</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="card-dark p-2 rounded-xl shadow-lg flex flex-wrap gap-2 mb-8 overflow-x-auto">
            <button class="tab flex-1 min-w-[140px] px-4 py-3 rounded-lg font-medium text-gray-400 hover:text-white hover:bg-slate-700/50 transition duration-150 active bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg flex items-center justify-center gap-2" 
                    onclick="switchTab(event, 'ai')">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path><path d="M8.5 8.5v.01"></path><path d="M16 12v.01"></path><path d="M12 16v.01"></path></svg>
                AI Assistant
            </button>
            <button class="tab flex-1 min-w-[140px] px-4 py-3 rounded-lg font-medium text-gray-400 hover:text-white hover:bg-slate-700/50 transition duration-150 flex items-center justify-center gap-2" 
                    onclick="switchTab(event, 'records')">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h8"></path><path d="M8 17h8"></path><path d="M10 9h4"></path></svg>
                Records
            </button>
            <button class="tab flex-1 min-w-[140px] px-4 py-3 rounded-lg font-medium text-gray-400 hover:text-white hover:bg-slate-700/50 transition duration-150 flex items-center justify-center gap-2" 
                    onclick="switchTab(event, 'health')">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                Analytics
            </button>
            <button class="tab flex-1 min-w-[140px] px-4 py-3 rounded-lg font-medium text-gray-400 hover:text-white hover:bg-slate-700/50 transition duration-150 flex items-center justify-center gap-2" 
                    onclick="switchTab(event, 'aegis')">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                Network
            </button>
        </div>

        <!-- Tab 1: AI Assistant -->
        <div id="tab-ai" class="tab-content active">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Report Summarizer Card -->
                <div class="card-dark p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-blue-500/10 rounded-lg mr-4">
                            <svg class="text-blue-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">Report Summarizer</h2>
                    </div>
                    <div class="space-y-5">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Upload Report (PDF):</label>
                            <input type="file" id="report-pdf" accept=".pdf" class="w-full text-sm text-gray-400 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-blue-400 hover:file:bg-slate-600 transition"/>
                        </div>
                        <div class="relative flex py-1 items-center">
                            <div class="flex-grow border-t border-slate-700"></div>
                            <span class="flex-shrink-0 mx-4 text-gray-500 text-xs uppercase">Or</span>
                            <div class="flex-grow border-t border-slate-700"></div>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Paste Clinical Text:</label>
                            <textarea id="report-text" placeholder="Paste detailed medical text, lab results, or SOAP notes here..." class="input-dark w-full p-3 rounded-xl transition resize-y min-h-[140px] focus:ring-blue-500"></textarea>
                        </div>
                        <button class="btn-primary text-white font-semibold py-3 rounded-xl w-full flex items-center justify-center gap-2" onclick="summarizeReport()">
                            <span id="summarize-btn">Generate Summary</span>
                        </button>
                        <div id="summary-result" class="result-box mt-4 p-4 bg-slate-900/50 border-l-4 border-green-500 rounded-lg hidden">
                            <div class="flex items-center gap-2 text-green-400 mb-2 font-semibold text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                AI Analysis
                            </div>
                            <!-- Summarizer content now uses markdown-body class for styling -->
                            <div id="summary-content" class="markdown-body text-sm text-gray-300 leading-relaxed"></div>
                        </div>
                        <p class="text-xs text-center text-slate-500 mt-2">Data processed ephemerally. Do not use for definitive diagnosis.</p>
                    </div>
                </div>

                <!-- AI Chatbot Card -->
                <div class="card-dark p-6 rounded-2xl shadow-xl flex flex-col h-full">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-purple-500/10 rounded-lg mr-4">
                            <svg class="text-purple-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">Decision Support Bot</h2>
                    </div>
                    <div id="chat-box" class="chat-box flex-grow h-80 overflow-y-auto bg-slate-900/50 border border-slate-700 rounded-xl p-4 mb-4 space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                                <svg class="text-blue-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path></svg>
                            </div>
                            <div class="bg-slate-700 text-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-sm leading-relaxed">
                                <div class="markdown-body">
                                System Online. Ask about network-wide trends or differential diagnoses. I support **Full Markdown** for medical notes:
                                
                                - **Tables** for vitals
                                - `Code blocks` for dosages
                                - *Task lists* for procedures
                                - > Blockquotes for references
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="chat-input" placeholder="Ask MediBot about symptoms, treatments, or data trends..." 
                               class="input-dark w-full p-3 pr-12 rounded-xl focus:ring-purple-500 transition shadow-inner" 
                               onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" class="absolute right-2 top-2 p-1.5 text-gray-400 hover:text-white transition rounded-lg hover:bg-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                        <div class="absolute left-3 top-3 text-xs text-gray-500 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path></svg>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        Tip: Inputs are sanitized for security.
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Medical Records -->
        <div id="tab-records" class="tab-content hidden">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Share Medical Record Card -->
                <div class="card-dark p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-green-500/10 rounded-lg mr-4">
                            <svg class="text-green-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">Secure Submission</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Condition:</label>
                                <input type="text" id="record-condition" placeholder="e.g. Sepsis" class="input-dark w-full p-3 rounded-xl focus:ring-green-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-400 mb-2">Age:</label>
                                <input type="number" id="record-age" placeholder="45" min="0" max="150" class="input-dark w-full p-3 rounded-xl focus:ring-green-500">
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Findings (JSON format):</label>
                            <textarea id="record-data" placeholder='{"bp": "120/80", "hr": 72}' class="input-dark w-full p-3 rounded-xl focus:ring-green-500 font-mono text-sm min-h-[100px]"></textarea>
                        </div>
                        <div class="flex items-center pt-2 p-3 bg-slate-900/30 rounded-lg border border-slate-700/50">
                            <input type="checkbox" id="record-public" class="h-4 w-4 bg-slate-800 border-slate-600 rounded text-green-500 focus:ring-green-500 focus:ring-offset-slate-900">
                            <label for="record-public" class="ml-3 block text-sm font-medium text-gray-300">Share with Public Health Database</label>
                        </div>
                        <button class="w-full bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-500 hover:to-emerald-400 text-white font-semibold py-3 rounded-xl transition shadow-lg mt-4 flex justify-center items-center gap-2" onclick="shareRecord()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                            Submit (Anonymized)
                        </button>
                        <div id="share-result" class="result-box mt-4 p-4 bg-slate-900/50 border-l-4 border-green-500 rounded-lg hidden">
                            <div id="share-content" class="text-sm text-gray-300"></div>
                        </div>
                    </div>
                </div>

                <!-- Search Network Records Card -->
                <div class="card-dark p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-cyan-500/10 rounded-lg mr-4">
                            <svg class="text-cyan-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">Global Search</h2>
                    </div>
                    <div class="input-group relative">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Condition Query:</label>
                        <input type="text" id="search-condition" placeholder="e.g. Diabetes Type 2" class="input-dark w-full p-3 rounded-xl focus:ring-cyan-500 pl-10">
                        <div class="absolute bottom-3.5 left-3 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                    </div>
                    <button class="btn-primary text-white font-semibold py-3 rounded-xl w-full mt-6" onclick="searchRecords()">
                        Query Network
                    </button>
                    <div id="search-results" class="mt-6">
                        <div class="text-center py-8 text-slate-500 border-2 border-dashed border-slate-700 rounded-xl">
                            <p>Results will populate here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Public Health -->
        <div id="tab-health" class="tab-content hidden">
            <div class="card-dark p-6 rounded-2xl shadow-xl">
                <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                    <div class="p-3 bg-orange-500/10 rounded-lg mr-4">
                        <svg class="text-orange-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-100">Regional Epidemiology</h2>
                </div>
                <button class="btn-primary text-white font-semibold py-3 px-6 rounded-xl w-full max-w-sm mx-auto block mb-6 shadow-lg shadow-blue-500/20" onclick="loadHealthTrends()">
                    Fetch Aggregated Trends
                </button>
                <div id="trends-display" class="p-6 bg-slate-900/60 rounded-xl border border-slate-700/50 min-h-[200px] flex items-center justify-center">
                    <p class="text-gray-500 flex items-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        Awaiting data sync...
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab 4: Aegis Control -->
        <div id="tab-aegis" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Network Control -->
                <div class="card-dark p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-indigo-500/10 rounded-lg mr-4">
                            <svg class="text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">P2P Link</h2>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Peer Node URL:</label>
                        <input type="text" id="peer-url" placeholder="192.168.1.X:5000" class="input-dark w-full p-3 rounded-xl focus:ring-indigo-500">
                    </div>
                    <button class="btn-primary text-white font-semibold py-3 rounded-xl w-full mt-4" onclick="connectPeer()">Establish Connection</button>
                    <button class="bg-slate-700 hover:bg-slate-600 text-gray-200 font-semibold py-3 rounded-xl w-full mt-3 transition" onclick="loadPeers()">View Active Nodes</button>
                    <div id="peers-list" class="mt-4 text-sm text-gray-400"></div>
                </div>

                <!-- Blockchain -->
                <div class="card-dark p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-red-500/10 rounded-lg mr-4">
                            <svg class="text-red-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">Audit Ledger</h2>
                    </div>
                    <button class="w-full bg-gradient-to-r from-red-600 to-rose-500 hover:from-red-500 hover:to-rose-400 text-white font-semibold py-3 rounded-xl transition shadow-lg flex items-center justify-center gap-2" onclick="mineBlockchain()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        Mine & Verify
                    </button>
                    <button class="btn-primary text-white font-semibold py-3 rounded-xl w-full mt-3" onclick="showBlockchain()">Show Transactions</button>
                    <div id="blockchain-display" class="mt-4 text-sm text-gray-400 max-h-[200px] overflow-y-auto custom-scrollbar"></div>
                </div>
                
                <!-- Federated Learning -->
                <div class="card-dark p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center mb-6 pb-4 border-b border-slate-700">
                        <div class="p-3 bg-teal-500/10 rounded-lg mr-4">
                            <svg class="text-teal-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-100">Federated ML</h2>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Epochs / Rounds:</label>
                        <input type="number" id="train-rounds" value="3" min="1" max="10" class="input-dark w-full p-3 rounded-xl focus:ring-teal-500">
                    </div>
                    <button class="btn-primary text-white font-semibold py-3 rounded-xl w-full mt-4" onclick="startTraining()">Initialize Training</button>
                    <button class="bg-slate-700 hover:bg-slate-600 text-gray-200 font-semibold py-3 rounded-xl w-full mt-3 transition" onclick="evaluateModel()">Evaluate Model</button>
                    <div id="training-result" class="mt-4 p-3 bg-yellow-500/10 rounded-lg text-sm border border-yellow-500/20 hidden"></div>
                </div>
            </div>
        </div>

        <!-- Global Message Modal -->
        <div id="custom-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden" onclick="hideModal()">
            <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl shadow-2xl w-full max-w-sm m-4 transform transition-all scale-100" onclick="event.stopPropagation()">
                <div class="flex items-center mb-4">
                    <div id="modal-icon" class="text-2xl mr-3"></div>
                    <h3 id="modal-title" class="text-xl font-bold text-gray-100"></h3>
                </div>
                <!-- Modal content now supports markdown -->
                <div id="modal-message" class="text-gray-400 mb-6 leading-relaxed markdown-body"></div>
                <button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 rounded-xl transition" onclick="hideModal()">
                    Dismiss
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const API = 'http://localhost:8080/api';
        
        // --- SECURITY & MARKDOWN UTILS ---

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Secure Markdown Renderer with DOMPurify
        function renderMedicalMarkdown(text) {
            if (!text) return '';
            
            // Check if marked loaded successfully
            if (typeof marked === 'undefined') {
                console.warn('Marked.js not loaded, falling back to plain text');
                return escapeHtml(text);
            }
            
            // 1. Pre-process medical terms (custom styling logic)
            let processedText = text;
            processedText = processedText.replace(/(\d+\/\d+\s*mmHg|\d+\s*bpm|\d+\s*mg\/dL|\d+\s*mmol\/L)/g, '`$1`');
            
            const medicalTerms = ['diagnosis', 'prognosis', 'symptom', 'treatment', 'medication', 'dosage', 'contraindication', 'indication', 'monitoring'];
            medicalTerms.forEach(term => {
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                processedText = processedText.replace(regex, `**${term}**`);
            });
            
            try {
                // 2. Parse Markdown to HTML (synchronous)
                const rawHtml = marked.parse(processedText);

                // 3. SANITIZE HTML (Prevent XSS)
                const cleanHtml = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'ul', 'ol', 'li', 'strong', 'em', 'code', 'pre', 'blockquote', 'a', 'img', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'div', 'span', 'svg', 'path', 'rect', 'line', 'polyline', 'circle'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'class', 'id', 'target', 'viewBox', 'd', 'fill', 'stroke', 'stroke-width', 'stroke-linecap', 'stroke-linejoin']
                });

                return cleanHtml;
            } catch (error) {
                console.error('Markdown rendering error:', error);
                return escapeHtml(text); // Fallback
            }
        }
        
        // --- Modal Implementation ---

        function showModal(title, message, isError = false) {
            const modal = document.getElementById('custom-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const iconEl = document.getElementById('modal-icon');

            titleEl.textContent = title;
            messageEl.innerHTML = renderMedicalMarkdown(message); // Markdown support in modals

            if (isError) {
                iconEl.innerHTML = '<svg class="text-red-500 w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                titleEl.className = 'text-xl font-bold text-red-400';
            } else {
                iconEl.innerHTML = '<svg class="text-green-500 w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                titleEl.className = 'text-xl font-bold text-green-400';
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                messageEl.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }, 10);
        }

        function hideModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        // --- UI & Lifecycle Functions ---

        window.addEventListener('load', () => {
            checkStatus();
            setInterval(checkStatus, 5000);
        });

        function switchTab(event, tab) {
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-white', 'shadow-lg');
                t.classList.add('text-gray-400');
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

            const btn = event.target.closest('button');
            btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-white', 'shadow-lg');
            btn.classList.remove('text-gray-400');
            document.getElementById('tab-' + tab).classList.remove('hidden');
        }

        async function safeFetch(url, options = {}) {
            let delay = 1000;
            const maxRetries = 2;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5;
                }
            }
        }


        async function checkStatus() {
            try {
                const data = await safeFetch(`${API}/status`);
                const setIndicator = (id, online) => {
                    const el = document.getElementById(id);
                    el.className = `w-2 h-2 rounded-full mr-2 shadow-[0_0_8px] ${online ? 'bg-green-500 shadow-green-500/50' : 'bg-red-500 shadow-red-500/50'}`;
                };
                setIndicator('groq-indicator', data.groq_available);
                document.getElementById('groq-status').textContent = data.groq_available ? 'Online' : 'Offline';
                document.getElementById('groq-status').className = `text-xl font-bold transition-colors ${data.groq_available ? 'text-white group-hover:text-green-400' : 'text-gray-500'}`;

                setIndicator('aegis-indicator', data.aegis_available);
                document.getElementById('aegis-status').textContent = data.aegis_available ? 'Online' : 'Offline';
                 document.getElementById('aegis-status').className = `text-xl font-bold transition-colors ${data.aegis_available ? 'text-white group-hover:text-green-400' : 'text-gray-500'}`;
                document.getElementById('public-data').textContent = data.public_health_records || 0;
                if (data.aegis_info) {
                    document.getElementById('peers-count').textContent = data.aegis_info.peers || 0;
                }
            } catch (err) {}
        }

        // --- AI Assistant Tab Functions ---

        async function summarizeReport() {
            const file = document.getElementById('report-pdf').files[0];
            const text = document.getElementById('report-text').value.trim();
            const resultBox = document.getElementById('summary-result');
            const contentEl = document.getElementById('summary-content');
            const buttonEl = document.getElementById('summarize-btn');
            
            if (!file && !text) {
                showModal('Input Required', 'Please upload a PDF or paste medical text.', true);
                return;
            }

            buttonEl.parentElement.innerHTML = '<span class="loading-spinner mr-2"></span> Processing...';
            resultBox.classList.add('hidden');

            try {
                let data;
                if (file) {
                    const form = new FormData();
                    form.append('file', file);
                    data = await safeFetch(`${API}/summarize`, {method: 'POST', body: form});
                } else {
                    data = await safeFetch(`${API}/summarize`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({text})
                    });
                }

                contentEl.innerHTML = renderMedicalMarkdown(data.summary || 'Summary could not be generated.');
                resultBox.classList.remove('hidden');
                setTimeout(() => {
                    contentEl.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });
                }, 10);

            } catch (err) {
                showModal('Summarization Failed', err.message, true);
            }
             document.querySelector('button[onclick="summarizeReport()"]').innerHTML = '<span id="summarize-btn">Generate Summary</span>';
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // Updated: Pass RAW message for markdown rendering
            addChatMessage(msg, 'user');
            input.value = '';

            const box = document.getElementById('chat-box');
            const loadingId = 'loading-' + Date.now();
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'flex items-start gap-3';
            loadingMsg.id = loadingId;
            loadingMsg.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                    <span class="loading-spinner w-4 h-4 border-2"></span>
                </div>
            `;
            box.appendChild(loadingMsg);
            box.scrollTop = box.scrollHeight;

            try {
                const data = await safeFetch(`${API}/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                document.getElementById(loadingId)?.remove();
                addChatMessage(data.response || 'No response received.', 'bot', data.data_enhanced);
            } catch (err) {
                document.getElementById(loadingId)?.remove();
                addChatMessage('Connection Error: ' + err.message, 'bot', false);
            }
        }

        function addChatMessage(text, sender, isEnhanced = false) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            
            // Generate HTML using secure markdown renderer for BOTH user and bot
            const renderedHtml = renderMedicalMarkdown(text);
            
            if (sender === 'user') {
                div.className = 'flex items-start gap-3 justify-end';
                // User bubble now supports markdown (bold, code, etc.)
                div.innerHTML = `
                    <div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none shadow-md max-w-[85%] text-sm leading-relaxed user-message-content">
                        <div class="markdown-body">
                            ${renderedHtml}
                        </div>
                    </div>
                `;
            } else {
                div.className = 'flex items-start gap-3';
                let badge = '';
                if (isEnhanced) {
                    badge = '<span class="inline-block bg-cyan-500/20 text-cyan-400 text-xs px-2 py-0.5 rounded-full border border-cyan-500/30 mb-2">Network Data Enhanced</span>';
                }
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                         <svg class="text-blue-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path></svg>
                    </div>
                    <div class="bg-slate-700 text-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-sm leading-relaxed border border-slate-600">
                        ${badge}
                        <div class="markdown-body">
                            ${renderedHtml}
                        </div>
                    </div>
                `;
            }

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            setTimeout(() => {
                div.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }, 10);
        }

        // --- Medical Records Tab Functions ---

        async function shareRecord() {
            const condition = document.getElementById('record-condition').value;
            const ageVal = document.getElementById('record-age').value;
            const dataText = document.getElementById('record-data').value;
            const isPublic = document.getElementById('record-public').checked;
            const resultBox = document.getElementById('share-result');
            const contentEl = document.getElementById('share-content');

            if (!condition || !ageVal) {
                showModal('Validation Error', 'Condition and Age are required.', true);
                return;
            }
            
            const age = parseInt(ageVal);
            if (isNaN(age) || age < 0 || age > 150) {
                showModal('Validation Error', 'Please enter a valid age between 0 and 150.', true);
                return;
            }

            let data = {};
            try {
                data = dataText ? JSON.parse(dataText) : {};
            } catch {
                showModal('Format Error', 'Findings must be valid JSON.', true);
                return;
            }

            const record = {
                condition: escapeHtml(condition), 
                age: age,
                ...data,
                record_id: 'REC-' + Math.random().toString(36).substr(2, 9).toUpperCase()
            };

            resultBox.classList.add('hidden');

            try {
                const result = await safeFetch(`${API}/records/share`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({record, public: isPublic})
                });
                
                contentEl.innerHTML = result.success ? 
                    `<span class="text-green-400 font-bold">‚úì Success</span>: Record <span class="font-mono text-xs bg-slate-800 p-1 rounded">${result.record_id}</span> secured & transmitted.` : 
                    `<span class="text-red-400">Error</span>: ${result.error}`;
                resultBox.classList.remove('hidden');
                checkStatus();
            } catch (err) {
                showModal('Submission Error', err.message, true);
            }
        }

        async function searchRecords() {
            const condition = document.getElementById('search-condition').value;
            const div = document.getElementById('search-results');
            div.innerHTML = '<div class="text-center py-6 text-cyan-400"><span class="loading-spinner mr-2 border-cyan-500 border-t-transparent"></span> Scanning distributed ledger...</div>';
            
            try {
                const data = await safeFetch(`${API}/records/search`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: {condition}})
                });
                
                if (data.records && data.records.length > 0) {
                    let html = `<div class="overflow-hidden rounded-xl border border-slate-700 shadow-2xl">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-slate-800 border-b border-slate-700">
                                <tr>
                                    <th class="px-6 py-4">Diagnosis</th>
                                    <th class="px-6 py-4">Demographic</th>
                                    <th class="px-6 py-4">Origin Node</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700 bg-slate-900/50">`;
                    
                    html += data.records.map(r => `
                        <tr class="hover:bg-slate-800/50 transition">
                            <td class="px-6 py-4 font-medium text-white">${escapeHtml(r.condition || 'Unknown')}</td>
                            <td class="px-6 py-4 text-gray-400">${escapeHtml(r.age_group || 'N/A')}</td>
                            <td class="px-6 py-4 text-xs font-mono text-cyan-500">${escapeHtml(r.hospital_id || 'LOCAL')}</td>
                        </tr>
                    `).join('');
                    html += '</tbody></table></div>';
                    div.innerHTML = html;
                } else {
                    div.innerHTML = `<div class="text-center py-6 text-gray-500 bg-slate-800/50 rounded-xl border border-slate-700">No records found matching "${escapeHtml(condition)}" in active nodes.</div>`;
                }
            } catch (err) {
                div.innerHTML = `<div class="text-center py-6 text-red-400">Search failed: ${escapeHtml(err.message)}</div>`;
            }
        }

        async function loadHealthTrends() {
            const div = document.getElementById('trends-display');
            div.innerHTML = '<div class="text-center text-orange-400"><span class="loading-spinner mr-2 border-orange-500 border-t-transparent"></span> Aggregating data...</div>';

            try {
                const data = await safeFetch(`${API}/health/trends`);
                if (data.trends) {
                    const t = data.trends;
                    let html = `
                        <div class="w-full">
                            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                                <h3 class="text-lg font-bold text-gray-200">Regional Analytics</h3>
                                <span class="bg-blue-500/10 text-blue-400 text-xs px-2 py-1 rounded border border-blue-500/20">N=${t.total_records} Records</span>
                            </div>
                            <div class="grid sm:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Top Pathologies</h4>
                                    <div class="space-y-3">
                                        ${Object.entries(t.conditions).map(([k,v]) => `
                                            <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700/50">
                                                <span class="text-gray-300 text-sm">${escapeHtml(k)}</span>
                                                <span class="text-orange-400 font-mono font-bold">${v}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Demographics</h4>
                                    <div class="space-y-3">
                                        ${Object.entries(t.age_groups).map(([k,v]) => `
                                            <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700/50">
                                                <span class="text-gray-300 text-sm">${escapeHtml(k)}</span>
                                                <span class="text-blue-400 font-mono font-bold">${v}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    div.innerHTML = html;
                } else {
                    div.innerHTML = `<p class="text-gray-500">No sufficient data for analysis.</p>`;
                }
            } catch (err) {
                div.innerHTML = `<p class="text-red-400">Analytics Error: ${escapeHtml(err.message)}</p>`;
            }
        }

        async function connectPeer() {
            const url = document.getElementById('peer-url').value.trim();
            if (!url) return;
            try {
                const data = await safeFetch(`${API}/aegis/connect`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url})
                });
                showModal('Connection Established', data.message);
                checkStatus();
            } catch (err) {
                showModal('Handshake Failed', err.message, true);
            }
        }

        async function loadPeers() {
            const div = document.getElementById('peers-list');
            div.innerHTML = '<span class="loading-spinner border-indigo-500 border-t-transparent mr-2"></span> Scanning topology...';
            try {
                const data = await safeFetch(`${API}/aegis/peers`);
                if (data.peers && data.peers.length > 0) {
                    let html = `<ul class="space-y-2 mt-2">`;
                    html += data.peers.map(p => `
                        <li class="flex items-center justify-between bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="flex flex-col">
                                <span class="text-indigo-400 font-mono text-xs">${escapeHtml(p.id)}</span>
                                <span class="text-gray-500 text-xs">${escapeHtml(p.url)}</span>
                            </div>
                            <span class="text-green-500 text-xs font-bold flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                ${Math.round(p.last_seen)}s
                            </span>
                        </li>
                    `).join('');
                    html += '</ul>';
                    div.innerHTML = html;
                } else {
                    div.innerHTML = '<p class="mt-2 text-gray-500 italic">No other nodes detected in cluster.</p>';
                }
            } catch (err) {
                div.innerHTML = `<p class="mt-2 text-red-400">Topology Scan Error: ${escapeHtml(err.message)}</p>`;
            }
        }

        async function mineBlockchain() {
            try {
                const data = await safeFetch(`${API}/aegis/mine`, {method: 'POST'});
                showModal('Block Mined', `Consensus reached. Block added to height ${data.length}.`);
            } catch (err) {
                showModal('Consensus Error', err.message, true);
            }
        }

        async function showBlockchain() {
            const div = document.getElementById('blockchain-display');
            div.innerHTML = '<span class="loading-spinner border-red-500 border-t-transparent mr-2"></span> Fetching ledger...';
            try {
                const data = await safeFetch(`${API}/aegis/blockchain`);
                if (data.transactions) {
                    let html = `<div class="space-y-3 mt-2">`;
                    html += data.transactions.map((t, i) => `
                        <div class="bg-slate-800 p-3 rounded border-l-2 ${i===0 ? 'border-yellow-500' : 'border-slate-600'}">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-gray-300">Block #${t.block_index}</span>
                                <span class="text--[10px] bg-slate-700 px-1.5 py-0.5 rounded text-gray-400 font-mono">${escapeHtml((t.block_hash || '').substring(0,8))}...</span>
                            </div>
                            <div class="text-xs text-blue-400">${escapeHtml(t.type)}</div>
                        </div>
                    `).join('');
                    html += '</div>';
                    div.innerHTML = html;
                }
            } catch (err) {
                div.innerHTML = `<p class="mt-2 text-red-400">Ledger Error: ${escapeHtml(err.message)}</p>`;
            }
        }

        async function startTraining() {
            const rounds = document.getElementById('train-rounds').value;
            const div = document.getElementById('training-result');
            div.classList.remove('hidden');
            div.innerHTML = '<span class="loading-spinner border-teal-500 border-t-transparent mr-2"></span> Orchestrating federated rounds...';
            try {
                const data = await safeFetch(`${API}/aegis/train`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({rounds: parseInt(rounds)})
                });
                div.innerHTML = `<p class="text-teal-400 font-bold mb-1">Training Complete</p><p class="text-gray-400 text-xs">${escapeHtml(data.message)}</p>`;
            } catch (err) {
                div.innerHTML = `<p class="text-red-400">Federation Error: ${escapeHtml(err.message)}</p>`;
            }
        }

        async function evaluateModel() {
            const div = document.getElementById('training-result');
            div.classList.remove('hidden');
            div.innerHTML = '<span class="loading-spinner border-teal-500 border-t-transparent mr-2"></span> Validating global model...';
            try {
                const data = await safeFetch(`${API}/aegis/model/evaluate`);
                if (data.metrics) {
                    const m = data.metrics;
                    div.innerHTML = `
                        <div class="flex justify-between items-end mb-2">
                             <h4 class="font-bold text-teal-400">Global Model Stats</h4>
                             <span class="text-[10px] text-gray-500">v1.2.4</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-slate-800 p-2 rounded text-center">
                                <div class="text-gray-500">Accuracy</div>
                                <div class="text-white font-mono">${(m.accuracy * 100).toFixed(1)}%</div>
                            </div>
                             <div class="bg-slate-800 p-2 rounded text-center">
                                <div class="text-gray-500">F1 Score</div>
                                <div class="text-white font-mono">${(m.f1_score * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    `;
                } else {
                     div.innerHTML = '<p class="text-gray-500 italic">No model version found. Initiate training.</p>';
                }
            } catch (err) {
                div.innerHTML = `<p class="text-red-400">Validation Error: ${escapeHtml(err.message)}</p>`;
            }
        }
    </script>
</body>
</html>
